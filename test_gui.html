<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Twin Test GUI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 3px dashed #ddd;
            transition: all 0.3s;
        }

        .upload-card:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-card.has-image {
            border-color: #28a745;
            border-style: solid;
        }

        .upload-card.quality-bad {
            border-color: #dc3545;
            background: #ffe0e0;
        }

        .upload-label {
            font-weight: bold;
            margin-bottom: 15px;
            display: block;
            color: #333;
            font-size: 1.1em;
        }

        .upload-area {
            cursor: pointer;
            padding: 30px;
            background: white;
            border-radius: 10px;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .quality-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        .quality-good {
            background: #28a745;
            color: white;
        }

        .quality-bad {
            background: #dc3545;
            color: white;
        }

        .quality-issues {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            font-size: 13px;
            text-align: left;
        }

        .measurements {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .measurement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .measurement-item {
            display: flex;
            flex-direction: column;
        }

        .measurement-item label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .measurement-item input {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        button {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .result-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .result-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        input[type="file"] {
            display: none;
        }

        .instructions {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .instructions h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .instructions ul {
            margin-left: 20px;
            color: #555;
        }

        .instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ Digital Twin Test GUI</h1>
        <p class="subtitle">Upload photos and generate 3D body models</p>

        <div class="config-section">
            <h3>‚öôÔ∏è RunPod Configuration</h3>
            <input 
                type="text" 
                id="apiEndpoint" 
                class="config-input" 
                placeholder="Enter your RunPod API Endpoint (e.g., https://api.runpod.ai/v2/YOUR_ENDPOINT_ID/runsync)"
                value="">
            <input 
                type="password" 
                id="apiKey" 
                class="config-input" 
                placeholder="Enter your RunPod API Key"
                value="">
        </div>

        <div class="instructions">
            <h3>üì∏ Photo Instructions</h3>
            <ul>
                <li>Take 3 photos: <strong>Front view</strong>, <strong>Side view (90¬∞)</strong>, and <strong>Back view (180¬∞)</strong></li>
                <li>Stand 2-3 meters from camera with good lighting</li>
                <li>Wear fitted clothing to show body shape</li>
                <li>Use plain background if possible</li>
                <li>Keep camera steady to avoid blur</li>
            </ul>
        </div>

        <div class="upload-grid">
            <div class="upload-card" id="card1">
                <span class="upload-label">üì∑ Front View</span>
                <label for="photo1" class="upload-area" id="preview1">
                    <div class="upload-icon">‚¨ÜÔ∏è</div>
                    <div>Click to upload photo</div>
                </label>
                <input type="file" id="photo1" accept="image/*">
            </div>

            <div class="upload-card" id="card2">
                <span class="upload-label">üì∑ Side View</span>
                <label for="photo2" class="upload-area" id="preview2">
                    <div class="upload-icon">‚¨ÜÔ∏è</div>
                    <div>Click to upload photo</div>
                </label>
                <input type="file" id="photo2" accept="image/*">
            </div>

            <div class="upload-card" id="card3">
                <span class="upload-label">üì∑ Back View</span>
                <label for="photo3" class="upload-area" id="preview3">
                    <div class="upload-icon">‚¨ÜÔ∏è</div>
                    <div>Click to upload photo</div>
                </label>
                <input type="file" id="photo3" accept="image/*">
            </div>
        </div>

        <div class="measurements">
            <h3>üìè Body Measurements</h3>
            <div class="measurement-grid">
                <div class="measurement-item">
                    <label>Height (cm)</label>
                    <input type="number" id="height" value="170" min="140" max="210">
                </div>
                <div class="measurement-item">
                    <label>Weight (kg)</label>
                    <input type="number" id="weight" value="70" min="40" max="150">
                </div>
                <div class="measurement-item">
                    <label>Shoulder Width (cm)</label>
                    <input type="number" id="shoulder" value="40" min="30" max="60">
                </div>
                <div class="measurement-item">
                    <label>Chest (cm)</label>
                    <input type="number" id="chest" value="90" min="70" max="140">
                </div>
                <div class="measurement-item">
                    <label>Waist (cm)</label>
                    <input type="number" id="waist" value="80" min="60" max="130">
                </div>
                <div class="measurement-item">
                    <label>Hips (cm)</label>
                    <input type="number" id="hips" value="95" min="70" max="140">
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-secondary" id="analyzeBtn">
                üîç Analyze Photo Quality
            </button>
            <button class="btn-primary" id="generateBtn" disabled>
                üéØ Generate Digital Twin
            </button>
        </div>

        <div class="result-section" id="resultSection" style="display: none;">
            <h3>üìä Results</h3>
            <div class="result-content" id="resultContent"></div>
        </div>
    </div>

    <script>
        let photoData = [null, null, null];
        let qualityResults = [null, null, null];

        for (let i = 1; i <= 3; i++) {
            const input = document.getElementById(`photo${i}`);
            const preview = document.getElementById(`preview${i}`);
            const card = document.getElementById(`card${i}`);

            input.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        photoData[i-1] = event.target.result;
                        
                        preview.innerHTML = `
                            <img src="${event.target.result}" class="preview-image">
                            <div>‚úì Photo uploaded</div>
                        `;
                        card.classList.add('has-image');
                        
                        updateGenerateButton();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function updateGenerateButton() {
            const allPhotosUploaded = photoData.every(p => p !== null);
            const apiEndpoint = document.getElementById('apiEndpoint').value;
            const apiKey = document.getElementById('apiKey').value;
            
            document.getElementById('generateBtn').disabled = 
                !allPhotosUploaded || !apiEndpoint || !apiKey;
        }

        document.getElementById('apiEndpoint').addEventListener('input', updateGenerateButton);
        document.getElementById('apiKey').addEventListener('input', updateGenerateButton);

        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const apiEndpoint = document.getElementById('apiEndpoint').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!apiEndpoint || !apiKey) {
                alert('Please enter RunPod API endpoint and key');
                return;
            }

            const uploadedPhotos = photoData.filter(p => p !== null);
            if (uploadedPhotos.length === 0) {
                alert('Please upload at least one photo');
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            btn.innerHTML = '<div class="spinner"></div> Analyzing...';
            btn.disabled = true;

            try {
                for (let i = 0; i < 3; i++) {
                    if (photoData[i]) {
                        const response = await fetch(apiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                input: {
                                    action: 'analyze_photo',
                                    photo: photoData[i]
                                }
                            })
                        });

                        const result = await response.json();
                        qualityResults[i] = result;

                        const card = document.getElementById(`card${i+1}`);
                        const preview = document.getElementById(`preview${i+1}`);

                        if (result.is_good) {
                            card.classList.remove('quality-bad');
                            preview.innerHTML += `
                                <span class="quality-badge quality-good">‚úì Good Quality</span>
                            `;
                        } else {
                            card.classList.add('quality-bad');
                            const issuesHtml = result.issues.map(issue => `‚Ä¢ ${issue}`).join('<br>');
                            preview.innerHTML += `
                                <span class="quality-badge quality-bad">‚úó Quality Issues</span>
                                <div class="quality-issues">${issuesHtml}</div>
                            `;
                        }
                    }
                }

                showResult('success', 'Photo quality analysis complete!');
            } catch (error) {
                showResult('error', `Error analyzing photos: ${error.message}`);
            } finally {
                btn.innerHTML = 'üîç Analyze Photo Quality';
                btn.disabled = false;
            }
        });

        document.getElementById('generateBtn').addEventListener('click', async () => {
            const apiEndpoint = document.getElementById('apiEndpoint').value;
            const apiKey = document.getElementById('apiKey').value;

            const measurements = {
                height: parseInt(document.getElementById('height').value),
                weight: parseInt(document.getElementById('weight').value),
                shoulderWidth: parseInt(document.getElementById('shoulder').value),
                chestCircumference: parseInt(document.getElementById('chest').value),
                waistCircumference: parseInt(document.getElementById('waist').value),
                hipCircumference: parseInt(document.getElementById('hips').value)
            };

            const btn = document.getElementById('generateBtn');
            btn.innerHTML = '<div class="spinner"></div> Generating Digital Twin...';
            btn.disabled =btn.disabled = true;

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        input: {
                            action: 'generate_twin',
                            photos: photoData,
                            measurements: measurements
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccessResult(result);
                } else {
                    showResult('error', result.error || 'Failed to generate digital twin');
                }
            } catch (error) {
                showResult('error', `Error: ${error.message}`);
            } finally {
                btn.innerHTML = 'üéØ Generate Digital Twin';
                btn.disabled = false;
            }
        });

        function showResult(type, message) {
            const section = document.getElementById('resultSection');
            const content = document.getElementById('resultContent');
            
            section.style.display = 'block';
            
            if (type === 'success') {
                content.innerHTML = `<div class="success-message">${message}</div>`;
            } else {
                content.innerHTML = `<div class="error-message">${message}</div>`;
            }

            section.scrollIntoView({ behavior: 'smooth' });
        }

        function showSuccessResult(result) {
            const section = document.getElementById('resultSection');
            const content = document.getElementById('resultContent');
            
            section.style.display = 'block';
            
            const stats = result.statistics;
            
            content.innerHTML = `
                <div class="success-message">
                    <strong>‚úì Digital Twin Generated Successfully!</strong>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${stats.num_vertices}</div>
                        <div class="stat-label">Vertices</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.num_faces}</div>
                        <div class="stat-label">Faces</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.num_matches}</div>
                        <div class="stat-label">Matches</div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button onclick="downloadMesh('${result.mesh_obj_base64}')" 
                            style="width: 100%; padding: 15px; background: #28a745; color: white; 
                                   border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">
                        üì• Download OBJ File
                    </button>
                </div>

                <div style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 10px;">
                    <strong>üìã Integration Code for Flutter:</strong>
                    <pre style="background: #fff; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 10px; font-size: 12px;">
final response = await http.post(
  Uri.parse('${document.getElementById('apiEndpoint').value}'),
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_API_KEY',
  },
  body: jsonEncode({
    'input': {
      'action': 'generate_twin',
      'photos': [photo1Base64, photo2Base64, photo3Base64],
      'measurements': {
        'height': ${stats.num_vertices > 0 ? document.getElementById('height').value : 170},
        'weight': ${stats.num_vertices > 0 ? document.getElementById('weight').value : 70},
        'shoulderWidth': ${stats.num_vertices > 0 ? document.getElementById('shoulder').value : 40},
        'chestCircumference': ${stats.num_vertices > 0 ? document.getElementById('chest').value : 90},
        'waistCircumference': ${stats.num_vertices > 0 ? document.getElementById('waist').value : 80},
        'hipCircumference': ${stats.num_vertices > 0 ? document.getElementById('hips').value : 95},
      }
    }
  }),
);</pre>
                </div>
            `;

            section.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadMesh(base64Data) {
            const objData = atob(base64Data);
            const blob = new Blob([objData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'digital_twin.obj';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
